# Nahma Server Stack
# 
# This docker-compose file runs the complete Nahma web deployment:
# - nginx: Serves static frontend + reverse proxy for signaling
# - signaling: WebRTC signaling server
# - persistence: Document persistence node (stores encrypted blobs)
#
# Usage:
#   docker-compose up -d
#
# For production, use with SSL certificates (see QNAP_GUIDE.md)

version: '3.8'

services:
  # Nginx - serves static files and proxies WebSocket
  nginx:
    build:
      context: ../..
      dockerfile: server/docker/Dockerfile.web
    container_name: nahma-web
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Mount SSL certificates (generate with certbot)
      - ./ssl:/etc/nginx/ssl:ro
      # Optional: custom nginx config
      # - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - signaling
    networks:
      - nahma-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Signaling server for WebRTC peer discovery
  signaling:
    build:
      context: ../..
      dockerfile: server/docker/Dockerfile.signal
    container_name: nahma-signal
    restart: unless-stopped
    environment:
      - PORT=4444
      - MAX_PEERS_PER_ROOM=50
    networks:
      - nahma-network
    # Not exposed directly - accessed via nginx reverse proxy
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(4444, () => process.exit(0))"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Persistence node - stores encrypted document state
  persistence:
    build:
      context: ../..
      dockerfile: server/docker/Dockerfile.persist
    container_name: nahma-persist
    restart: unless-stopped
    environment:
      - SIGNALING_URL=ws://signaling:4444
      - DB_PATH=/app/data/persistence.db
    volumes:
      - nahma-data:/app/data
    depends_on:
      - signaling
    networks:
      - nahma-network

networks:
  nahma-network:
    driver: bridge

volumes:
  nahma-data:
    driver: local
