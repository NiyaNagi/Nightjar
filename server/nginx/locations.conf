# Location blocks for nginx
# Included in main nginx.conf

# WebSocket signaling endpoint
location /signal {
    limit_req zone=websocket burst=10 nodelay;
    
    proxy_pass http://nightjar;
    proxy_http_version 1.1;
    
    # WebSocket upgrade
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeouts for long-lived connections
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    
    # Buffering
    proxy_buffering off;
}

# y-websocket document sync (all other WebSocket paths)
location ~ ^/[a-zA-Z0-9_:\-]+ {
    limit_req zone=websocket burst=10 nodelay;

    # Only proxy if it's a WebSocket upgrade; otherwise fall through to static
    if ($http_upgrade != "websocket") {
        break;
    }

    proxy_pass http://nightjar;
    proxy_http_version 1.1;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    proxy_buffering off;
}

# API endpoints
location /api/ {
    limit_req zone=general burst=20 nodelay;

    proxy_pass http://nightjar;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Static files
location / {
    limit_req zone=general burst=20 nodelay;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # SPA routing - serve index.html for all routes
    try_files $uri $uri/ /index.html;
    
    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Don't cache HTML
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
}

# Block sensitive paths
location ~ /\. {
    deny all;
}

location ~ ^/(\.git|node_modules) {
    deny all;
}
